[{"name":"app.R","content":"suppressPackageStartupMessages(library(shiny))\r\nsuppressPackageStartupMessages(library(rjson))\r\nsuppressPackageStartupMessages(library(ComplexHeatmap))\r\nsuppressPackageStartupMessages(library(circlize))\r\nsuppressPackageStartupMessages(library(htmltools))\r\nsuppressPackageStartupMessages(library(dplyr))\r\nsuppressPackageStartupMessages(library(tidyr))\r\nprint(\"VVV All error messages from the app are below this line VVV\")\r\n\r\nui <- fluidPage(\r\n  \r\n  tags$head(\r\n    tags$style(HTML(\"\r\n      body {\r\n        background-color: #3F3F3F;\r\n      }\r\n      .import_shift {\r\n        margin-top: 25px;\r\n      }\r\n      .red_text {\r\n        color: #BB0000;\r\n      }\r\n      .green_text {\r\n        color: #00DD00;\r\n      }\r\n      \")),\r\n    tags$script(HTML(\"\r\n      // Fetch data from the Netlify proxy.\r\n      function fetch_netlify(params) {\r\n        const netlify_url = 'https://brdv.netlify.app/.netlify/functions/datamall_proxy?year='\r\n                          + params.year + '&month=' + params.month + '&account_key=' + params.account_key;\r\n        // Return a promise that yields the netlify data.\r\n        return fetch(netlify_url).then(response => response.json());\r\n      }\r\n  \r\n      // Fetch CSV (data1) from Datamall.\r\n      function fetch_datamall(params) {\r\n          return new Promise(function(resolve, reject) {\r\n            var year = params.year;\r\n            var month = params.month;\r\n            var account_key = params.account_key;\r\n  \r\n        // Build the URL for the Datamall API call.\r\n        const data1_params = new URLSearchParams({ Date: year + month });\r\n        const data1_url = 'http://datamall2.mytransport.sg/ltaodataservice/PV/ODBus?' + data1_params.toString();\r\n        \r\n        fetch(data1_url, {\r\n          method: 'GET',\r\n          headers: {\r\n            'AccountKey': account_key,\r\n            'accept': 'application/json'\r\n          }\r\n        })\r\n        .then(response => response.json())\r\n        .then(csvJson => {\r\n          var link = (csvJson.value && csvJson.value[0]) ? csvJson.value[0].Link : null;\r\n          if (link) {\r\n               // Fetch the ZIP file pointed to by the link.\r\n               fetch(link)\r\n                .then(r => r.blob())\r\n                .then(blob => {\r\n                 var reader = new FileReader();\r\n                  reader.onload = function(e) {\r\n                   var data1_content = e.target.result;\r\n                    // Optionally update a status element:\r\n                    document.getElementById('upload_conf').innerHTML = '<span style=\\\"color:#00DD00; font-weight:bold;\\\">File import successful!<\/span>';\r\n                    resolve(data1_content);\r\n                  };\r\n                  reader.onerror = function(e) {\r\n                    reject('Error reading ZIP blob: ' + e);\r\n                  };\r\n                  reader.readAsText(blob);\r\n                })\r\n                .catch(err => {\r\n                  console.error('Error fetching ZIP file:', err);\r\n                  document.getElementById('upload_conf').innerHTML = '<span style=\\\"color:#BB0000; font-weight:bold;\\\">Error fetching CSV ZIP.<\/span>';\r\n                  reject(err);\r\n                });\r\n              } else {\r\n                document.getElementById('upload_conf').innerHTML = '<span style=\\\"color:#BB0000; font-weight:bold;\\\">You have reached the rate limit. Try again after a while.<\/span>';\r\n                reject('Rate limit reached or no link provided.');\r\n              }\r\n            })\r\n            .catch(err => {\r\n              console.error('Error fetching Datamall JSON:', err);\r\n              document.getElementById('upload_conf').innerHTML = '<span style=\\\"color:#BB0000; font-weight:bold;\\\">Error fetching CSV data.<\/span>';\r\n              reject(err);\r\n            });\r\n          });\r\n      }\r\n  \r\n      // Fetch JSON data (data2 & data3) from BusRouter.\r\n      function fetch_busrouter() {\r\n        var json_urls = [\r\n          'https://data.busrouter.sg/v1/services.json',\r\n          'https://data.busrouter.sg/v1/stops.json'\r\n        ];\r\n        return Promise.all(\r\n          json_urls.map(function(url) {\r\n            return fetch(url).then(function(response) {\r\n              if (!response.ok) {\r\n                throw new Error('Network response not ok for ' + url);\r\n              }\r\n              return response.json();\r\n            });\r\n          })\r\n        ).then(function(jsonArray) {\r\n          return { data2: jsonArray[0], data3: jsonArray[1] };\r\n        });\r\n          }\r\n    \r\n      // Combining Netlify and Datamall imports\r\n      function start_csv_fetch(params) {\r\n        fetch_netlify(params)\r\n          .then(function(netlify_data) {\r\n            return Promise.all([\r\n             fetch_datamall(params),\r\n            ]);\r\n          })\r\n          .then(function(data1_result) {\r\n            var data1_content = dataa1_result[1];\r\n        \r\n            var csv_data = {\r\n              data1: data1_content,\r\n            };\r\n            Shiny.setInputValue('csv_data', csv_data);\r\n          })\r\n        .catch(function(err) {\r\n          console.error('Error in CSV fetch chain:', err);\r\n          document.getElementById('upload_conf').innerHTML = '<span style=\\\"color:#BB0000; font-weight:bold;\\\">' + err + '<\/span>';\r\n          });\r\n        }\r\n      \r\n      // Busrouter imports\r\n      function start_json_fetch() {\r\n        fetch_busrouter()\r\n          .then(function(data2_3_result) {\r\n            var json_data = {\r\n              data2: data2_3_result.data2,\r\n              data3: data2_3_result.data3\r\n            };\r\n            Shiny.setInputValue('json_data_in', json_data);\r\n          })\r\n          .catch(function(err) {\r\n            console.error('Error in JSON fetch chain:', err);\r\n            document.getElementById('upload_conf').innerHTML = '<span style=\\\"color:#BB0000; font-weight:bold;\\\">' + err + '<\/span>';\r\n            });\r\n        }\r\n      // Custom Message Handlers\r\n      Shiny.addCustomMessageHandler('start_csv_fetch', function(params) {\r\n        start_csv_fetch(params);\r\n      });\r\n      Shiny.addCustomMessageHandler('start_json_fetch', function(params) {\r\n        start_json_fetch(params);\r\n      });\r\n\r\n      // Clear cache upon refresh\r\n      window.onbeforeunload = function(event) {\r\n        // Clear session storage\r\n        sessionStorage.clear();\r\n        // Clear local storage (or specific cache keys)\r\n        localStorage.clear();\r\n        // Clear caches created via the Cache API\r\n        if ('caches' in window) {\r\n          caches.keys().then(function(names) {\r\n            names.forEach(function(name) {\r\n              caches.delete(name);\r\n            });\r\n          });\r\n        }\r\n      };\r\n    \"))\r\n  ),\r\n  \r\n  titlePanel(tags$p(style = \"color: white; text-align: center\", \"Bus Route Demand Visualiser 1.4.1\")),\r\n  sidebarLayout(\r\n    sidebarPanel(\r\n      width = 5,\r\n      style = \"background-color: #7F7F7F;\",\r\n      tags$div(tags$h5(strong(\"Do you wish to auto import from LTA Datamall or upload CSV?\"))),\r\n      checkboxInput(\"autoimport\", \"Import from Datamall\", T),\r\n      conditionalPanel(\r\n        condition = \"input.autoimport == false\",\r\n        tags$div(tags$h5(strong(\"Please wait until you receive 'File Upload Successful!'.\", class = \"red_text\"))),\r\n        fileInput(\"data1_in\", \"Choose LTA Origin-Destination CSV\", width = \"500px\",\r\n                  accept = c(\".csv\", \".docx\", \".doc\"),\r\n        )),\r\n      conditionalPanel(\r\n        condition = \"input.autoimport == true\",\r\n        tags$div(tags$h5(strong(\"Put a leading zero in single-digit months, i.e. 01\", class = \"red_text\"))),\r\n        tags$div(tags$h5(strong(\"Please wait until you receive 'File Upload Successful!'.\", class = \"red_text\"))),\r\n        fluidRow(\r\n          splitLayout(\r\n            paste(\" \"),\r\n            textInput(\"year_in\",\"Select Year\", value = NA, width = \"80px\"),\r\n            textInput(\"month_in\",\"Month\", value = NA, width = \"80px\"),\r\n            div(class = \"import_shift\", actionButton(\"import\", \"Import\", width = \"80px\")),\r\n            cellWidths = c(\"10px\",\"80px\",\"80px\",\"80px\")\r\n          ),\r\n        )\r\n      ),\r\n      htmlOutput(\"upload_conf\"),\r\n      checkboxInput(\"seespecstops\", \"See specific bus stops\", F),\r\n      conditionalPanel(\r\n        condition = \"input.seespecstops == false\",\r\n        textInput(\"svc_in\", \"Which bus service would you like to see?\", width = \"500px\"),\r\n        radioButtons(\"svc_half_in\", \"Do you want to split route in half?\", width = \"500px\", choices = c(\"Full\", \"1st half\", \"2nd half\"), inline = T),\r\n        radioButtons(\"dir_in\", \"Which direction? For loop, put as 1.\", width = \"500px\", choices = c(1,2), inline = T)\r\n      ),\r\n      conditionalPanel(\r\n        condition = \"input.seespecstops == true\",\r\n        tags$div(tags$h5(strong(\"Warning! The bus stops you listed in the origin box must be paired with a corresponding bus stop in order in the destination box, i.e. 10009,10011 as origin, 10017,10018 as destination, 10009 pairs with 10017, 10011 pairs with 10018.\", class = \"red_text\"))),\r\n        textInput(\"ori_stops\", \"Which specific origin stops? Put a comma between bus stops.\", width = \"500px\"),\r\n        textInput(\"dst_stops\", \"Which specific destination stops? Put a comma between bus stops.\", width = \"500px\")\r\n      ),\r\n      tags$div(tags$h4(strong(\"Please select your filters. Filters available include time and day type filters.\"))),\r\n      radioButtons(\"day_filter\",\"Select Day Type filter\", choices = c(\"Combined\" = \"cmb\",\"Weekday\" = \"wkday\",\"Weekend/PH\" = \"wkend_ph\"), selected = c(\"cmb\"), inline = T),\r\n      tags$div(tags$h5(strong(\"Select Time Period filter\"))),\r\n      checkboxInput(\"time_filter\",\"Filter by Time Period\", F),\r\n      conditionalPanel(\r\n        condition = \"input.time_filter == true\",\r\n        tags$div(tags$h5(strong(\"For time filters, give in 24h format. For continuation to next day, let time since be greater than time until. Both equal are treated as full (Why would you do that?).\", class = \"red_text\"))),\r\n        radioButtons(\"more_time_filters\", \"Include how many time periods?\", choices = c(\"1\" = \"1\", \"2\" = \"2\", \"3\" = \"3\", \"4\" = \"4\"), selected = c(\"1\"), inline = T),\r\n        tags$div(tags$h5(strong(\"Select Time Period filter 1\", class = \"green_text\"))),\r\n        sliderInput(\"time_since1\",\"TP1: Since what hour?\", 0, 23, 0, step = 1, animate = F, width = \"200px\"),\r\n        sliderInput(\"time_until1\",\"TP2: Until what hour?\", 0, 23, 0, step = 1, animate = F, width = \"200px\"),\r\n        conditionalPanel(\r\n          condition = \"input.more_time_filters == '2' || input.more_time_filters == '3' || input.more_time_filters == '4'\",\r\n          tags$div(tags$h5(strong(\"Select Time Period filter 2\", class = \"green_text\"))),\r\n          sliderInput(\"time_since2\", \"TP2: Since what hour?\", 0, 23, 0, step = 1, animate = F, width = \"200px\"),\r\n          sliderInput(\"time_until2\", \"TP2: Until what hour?\", 0, 23, 0, step = 1, animate = F, width = \"200px\")\r\n        ),\r\n        conditionalPanel(\r\n          condition = \"input.more_time_filters == '3' || input.more_time_filters == '4'\",\r\n          tags$div(tags$h5(strong(\"Select Time Period filter 3\", class = \"green_text\"))),\r\n          sliderInput(\"time_since3\", \"TP3: Since what hour?\", 0, 23, 0, step = 1, animate = F, width = \"200px\"),\r\n          sliderInput(\"time_until3\", \"TP3: Until what hour?\", 0, 23, 0, step = 1, animate = F, width = \"200px\")\r\n        ),\r\n        conditionalPanel(\r\n          condition = \"input.more_time_filters == '4'\",\r\n          tags$div(tags$h5(strong(\"Select Time Period filter 4\", class = \"green_text\"))),\r\n          sliderInput(\"time_since4\", \"TP4: Since what hour?\", 0, 23, 0, step = 1, animate = F, width = \"200px\"),\r\n          sliderInput(\"time_until4\", \"TP4: Until what hour?\", 0, 23, 0, step = 1, animate = F, width = \"200px\")\r\n        ),\r\n      ),\r\n      conditionalPanel(\r\n        condition = \"input.seespecstops == false\",\r\n        checkboxGroupInput(\"stop_names\", \"Display bus stop names in\", choices = c(\"Rows\" = \"row_names\", \"Columns\" = \"column_names\"), selected = c(\"row_names\", \"column_names\"), inline = T),\r\n      ),\r\n      conditionalPanel(\r\n        condition = \"input.seespecstops == true\",\r\n        checkboxInput(\"stop_names2\", \"Display bus stop names in cells\", F),\r\n      ),\r\n      actionButton(\"generate\",\"Generate Table\", width = \"120px\")\r\n    ),\r\n    mainPanel(\r\n      htmlOutput(\"upload_conf2\"),\r\n      plotOutput(\"result_out\", inline = T)\r\n    )\r\n  )\r\n)\r\n\r\nserver <- function(input, output, session) {\r\n  \r\n  normalise_json <- function(json) {\r\n    jsonlite::fromJSON(jsonlite::toJSON(json), simplifyVector = TRUE)\r\n  }\r\n  \r\n  options(shiny.maxRequestSize=900*1024^2)\r\n  \r\n  svc <- reactive({input$svc_in})\r\n  dir <- reactive({input$dir_in})\r\n  svc_half <- reactive({input$svc_half_in})\r\n  year <- reactive({input$year_in})\r\n  month <- reactive({input$month_in})\r\n  data1 <- reactiveVal(NULL)\r\n  conf_msg <- reactiveVal(\"\")\r\n  conf_msg2 <- reactiveVal(\"\")\r\n  sp_ori <- reactive({input$ori_stops})\r\n  sp_dst <- reactive({input$dst_stops})\r\n  spec_stops <- reactive({input$seespecstops})\r\n  day_filter <- reactive(input$day_filter)\r\n  time_since <- reactive(input$time_since)\r\n  time_until <- reactive(input$time_until)\r\n  json_result <- reactive({\r\n    req(input$json_data_in)\r\n    normalise_json(input$json_data_in)\r\n  })\r\n  \r\n  interval2hours <- function(start, end) {\r\n    start <- as.numeric(start)\r\n    end <- as.numeric(end)\r\n    if (start < end) {\r\n      return(start:(end - 1))\r\n    } else if (start > end) {\r\n      # wrap-around: from start to 23 and from 0 up to (end - 1)\r\n      return(c(start:23, if (end > 0) 0:(end - 1) else integer(0)))\r\n    } else {\r\n      # When both are equal, treat as full day.\r\n      return(0:23)\r\n    }\r\n  }\r\n\r\n  observeEvent(input$data1_in, {\r\n    req(input$data1_in, !input$autoimport)\r\n    conf_msg(\"\")\r\n    pre_data1 <- read.csv(input$data1_in$datapath, colClasses = c(\"ORIGIN_PT_CODE\" = \"character\", \"DESTINATION_PT_CODE\" = \"character\"))\r\n    if (!is.null(data)) {\r\n      data1(pre_data1)\r\n      conf_msg(\"<span style='color:#00DD00; font-weight:bold;'>File upload successful!<\/span>\")\r\n    } else {\r\n      conf_msg(\"<span style='color:#BB0000; font-weight:bold;'>File upload failed. Please check for data corruption or correct file format.<\/span>\")\r\n    }\r\n  })\r\n\r\n  csv_fetch <- eventReactive(input$import, {\r\n    list(\r\n      year = input$year_in,\r\n      month = input$month_in,\r\n      account_key = \"1o+r1yqATGio3Rls/NnQGw==\"\r\n    )\r\n  })\r\n  \r\n  observeEvent(csv_fetch(), {\r\n    session$sendCustomMessage(\"start_csv_fetch\", csv_fetch())\r\n  })\r\n  \r\n  observeEvent(input$data1_data$data1, {\r\n    pre_data1 <- read.csv(text = input$data1_data, colClasses = c(\"ORIGIN_PT_CODE\" = \"character\", \"DESTINATION_PT_CODE\" = \"character\"))\r\n    data1(pre_data1)\r\n  })\r\n  \r\n  result <- eventReactive(input$generate, {\r\n    if (is.null(data1())) {\r\n      stop(\"You need to upload something, if not what do you wanna see?!\")\r\n    }\r\n    session$sendCustomMessage(\"start_json_fetch\", list())\r\n    json_data <- req(json_result())\r\n    data2 <- json_data$data2\r\n    data3 <- json_data$data3\r\n    svc2 <- as.character(svc())\r\n    dir2 <- as.numeric(dir())\r\n    year2 <- as.character(year())\r\n    month2 <- as.character(month())\r\n    if (identical(day_filter(), \"cmb\")) {\r\n      day_type <- \"Combined\"\r\n    } else if (identical(day_filter(), \"wkday\")) {\r\n      day_type <- \"Weekday\"\r\n    } else if (identical(day_filter(), \"wkend_ph\")) {\r\n      day_type <- \"Weekend/PH\"\r\n    }\r\n    filter_day_type <- if (\"wkday\" %in% input$day_filter) {\r\n      quo(DAY_TYPE == \"WEEKDAY\")\r\n    } else if (\"wkend_ph\" %in% input$day_filter) {\r\n      quo(DAY_TYPE == \"WEEKENDS/HOLIDAY\")\r\n    } else {\r\n      quo(TRUE)\r\n    }\r\n    if (input$time_filter) {\r\n      primary_start <- input$time_since1\r\n      primary_end   <- input$time_until1\r\n      valid_hours <- interval2hours(primary_start, primary_end)\r\n      time_period <- paste0(\"From \", if (nchar(primary_start) == 2) primary_start else paste0(\"0\", primary_start), \":00 to \", if (nchar(primary_end) == 2) primary_end else paste0(\"0\", primary_end), \":00\")\r\n      extra_count <- as.numeric(input$more_time_filters) - 1\r\n      if (extra_count >= 1) {\r\n        for (i in 2:(extra_count + 1)) {\r\n          extra_start <- input[[paste0(\"time_since\", i)]]\r\n          extra_end <- input[[paste0(\"time_until\", i)]]\r\n          extra_hours <- interval2hours(extra_start, extra_end)\r\n          valid_hours <- sort(unique(c(valid_hours, extra_hours)))\r\n          extra_period <- paste0(if (nchar(extra_start) == 2) extra_start else paste0(\"0\", extra_start), \":00 to \", if (nchar(extra_end) == 2) extra_end else paste0(\"0\", extra_end), \":00\")\r\n          time_period <- paste0(time_period, \", \", extra_period)\r\n        }\r\n      }\r\n      filter_time_period <- quo(TIME_PER_HOUR %in% valid_hours)\r\n    } else {\r\n      filter_time_period <- quo(TRUE)\r\n      time_period <- \"Full Day\"\r\n    }\r\n    if (identical(input$seespecstops, F)) {\r\n      stop_half_opt = svc_half()\r\n      stop_cur <- data2[[svc2]]$routes[[dir2]]\r\n      if (is.null(stop_cur)) {\r\n        stop(\"Invalid bus service. Is your bus service withdrawn?\")\r\n      }\r\n      terminus <- data3[[(stop_cur[length(stop_cur)])]][[3]]\r\n      is_2way <- length(data2[[svc2]]$routes)\r\n      stop_half <- round(length(stop_cur)/2)\r\n      if (is_2way == 2){\r\n        if (identical(stop_half_opt, \"1st half\")){\r\n          stop_cur2 <- stop_cur[1:(stop_half+3)]\r\n          dir_graph <- paste0(\"Direction \",dir2,\"\\n(\",stop_half_opt,\")\")\r\n        } else if (identical(stop_half_opt, \"2nd half\")) {\r\n          stop_cur2 <- stop_cur[(stop_half-3):length(stop_cur)]\r\n          dir_graph <- paste0(\"Direction \",dir2,\"\\n(\",stop_half_opt,\")\")\r\n        } else {\r\n          stop_cur2 <- stop_cur\r\n          dir_graph <- paste(\"Direction \",dir2)\r\n        } \r\n      } else {\r\n        if (identical(stop_half_opt, \"1st half\")){\r\n          stop_cur2 <- stop_cur[1:(3+stop_half)]\r\n          dir_graph <- paste0(\"Direction 1\\n(\",stop_half_opt,\")\")\r\n        } else if (identical(stop_half_opt, \"2nd half\")) {\r\n          stop_cur2 <- stop_cur[(stop_half-2):length(stop_cur)]\r\n          dir_graph <- paste0(\"Direction 1\\n(\",stop_half_opt,\")\")\r\n        } else {\r\n          stop_cur2 <- stop_cur\r\n          dir_graph <- \"Loop Svc\"\r\n        }}\r\n      V <- length(stop_cur2)\r\n      stop_names <- data.frame(as.character(c(stop_cur2)),c(1:V))\r\n      for (j in 1:V){\r\n        stop_names[j,2] <- data3[[(stop_cur2[j])]][[3]]\r\n      }\r\n      stop_cur0a <- data.frame(org = 1:V, ORIGIN_PT_CODE = stop_cur2)\r\n      stop_cur0b <- data.frame(dst = 1:V, DESTINATION_PT_CODE = stop_cur2)\r\n      dataod <- data1() %>%\r\n      filter(., ORIGIN_PT_CODE %in% stop_cur2 | is.na(ORIGIN_PT_CODE),\r\n            DESTINATION_PT_CODE %in% stop_cur2 | is.na(DESTINATION_PT_CODE),\r\n            !!filter_day_type, !!filter_time_period) %>%  \r\n      group_by(ORIGIN_PT_CODE, DESTINATION_PT_CODE) %>%\r\n      summarise(total = sum(TOTAL_TRIPS, na.rm = TRUE), .groups = \"drop\")\r\n      missing_org <- setdiff(stop_cur2, unique(dataod$ORIGIN_PT_CODE)) # Check for missing origin stops\r\n      missing_dst <- setdiff(stop_cur2, unique(dataod$DESTINATION_PT_CODE)) # Check for missing destination stops\r\n      if (length(missing_org) > 0) {\r\n        extra_rows <- tibble(ORIGIN_PT_CODE = unique(missing_org), DESTINATION_PT_CODE = NA, total = 0)  \r\n        dataod <- bind_rows(dataod, extra_rows) %>%\r\n          distinct(ORIGIN_PT_CODE, DESTINATION_PT_CODE, .keep_all = TRUE)  # Ensure uniqueness\r\n      }\r\n      if (length(missing_dst) > 0) {\r\n        extra_rows <- tibble(ORIGIN_PT_CODE = missing_dst, DESTINATION_PT_CODE = missing_dst, total = 0)  # Ensure uniqueness\r\n        dataod <- bind_rows(dataod, extra_rows) %>%\r\n          filter(DESTINATION_PT_CODE %in% stop_cur2)  # Ensure proper alignment\r\n      }\r\n      dataod0a <- full_join(dataod, stop_cur0a, by=\"ORIGIN_PT_CODE\")\r\n      dataod0b <- full_join(dataod0a, stop_cur0b, by=\"DESTINATION_PT_CODE\")\r\n      dataod2 <- dataod0b[order(dataod0b$org, dataod0b$dst), ]\r\n      dataod2$total <- as.numeric(dataod2$total)\r\n      dataod2a <- dataod2[,c(5,4,3)]\r\n      dataod2b <- dataod2[,c(2,1,3)]\r\n      dataod2c <- dataod2a %>%\r\n        spread(key = org, value = total, fill = NA)\r\n      extra_row <- setdiff(unique(dataod2c$dst), stop_cur2)  # Identify the unwanted row\r\n      dataod2c[is.na(dataod2c)] <- 0\r\n      dataod2c <- dataod2c %>%\r\n        filter(dst != 0)  # Keeps all valid rows, removes the incorrect one\r\n      stop_cur3a <- stop_cur2[1:V-1]\r\n      stop_cur3b <- stop_cur2[2:V]\r\n      dataod2e <- as.matrix(dataod2c)\r\n      dataod2e <- dataod2e[,-1]\r\n      ncol(dataod2e)\r\n      if (ncol(dataod2e)!=(V-1)){\r\n        dataod2e <- dataod2e[,-ncol(dataod2e)]\r\n      }\r\n      if (nrow(dataod2e)!=(V-1)){\r\n        dataod2e <- dataod2e[-1,]\r\n      }\r\n      dataod2g <- dataod2e\r\n      dataod2h <- dataod2g\r\n      rownames(dataod2g) <- paste(2:V)\r\n      colnames(dataod2h) <- paste(stop_cur3a)\r\n      rownames(dataod2h) <- paste(stop_cur3b)\r\n      odgroup_crowd <- rep(\"Origin stop\",V-1)\r\n      odgroup1 <- odgroup_crowd\r\n      cols = colorRamp2(c(0, 1, 30, 300, 1500, 6000, 30000, 99000), c(\"gray60\",\"white\",\"white\", \"yellow\", \"orange\", \"red\", \"darkred\",\"black\"))\r\n      max_length <- 2 * max(nchar(stop_names[,2]))\r\n      column_labels <- if (\"column_names\" %in% input$stop_names) {\r\n        paste(stop_names[1:nrow(stop_names)-1,1], \"     \", stop_names[1:nrow(stop_names)-1,2], sep = \"\")\r\n      } else {\r\n        paste(stop_names[1:nrow(stop_names)-1,1])\r\n      }\r\n      row_labels <- if (\"row_names\" %in% input$stop_names) {\r\n        paste(stop_names[2:nrow(stop_names),2], \"     \", stop_names[2:nrow(stop_names),1], sep = \"\")\r\n      } else {\r\n        paste(stop_names[2:nrow(stop_names)-1,1])\r\n      }\r\n      img_dims <- list(width = 40 * ncol(dataod2h) + 400, height = 23 * nrow(dataod2h) + 140)\r\n      img <- Heatmap(dataod2h,\r\n        name = paste(\"O-D matrix (en-route)\\n\",data1()$YEAR_MONTH[[1]], \"\\n\",day_type,\" Demand\\n\\nService \",svc2,\"\\n\",dir_graph,\"\\n\",terminus,\" Bound\\n\",sep = \"\"),\r\n        show_column_dend = FALSE,\r\n        show_row_dend = FALSE,\r\n        row_dend_reorder = FALSE,\r\n        column_dend_reorder = FALSE,\r\n        column_title = paste0(time_period, \"\\nOrigin Bus Stops\"),\r\n        column_title_side = \"top\",\r\n        row_title = \"Destination Bus Stops\",\r\n        row_names_side = \"left\",\r\n        column_names_side = \"top\",\r\n        column_names_rot = 40,\r\n        column_labels = column_labels,\r\n        row_labels = row_labels,\r\n        col = cols,\r\n        na_col = \"gray60\",\r\n        column_split = odgroup1,\r\n        column_gap = unit(2, \"mm\"),\r\n        cluster_rows = FALSE,\r\n        cluster_columns = FALSE,\r\n        row_order = stop_cur3b,\r\n        column_order = stop_cur3a, \r\n        row_names_gp = gpar(fontsize = pmin(ncol(dataod2h) / 3 + 9, 15), just = \"right\"),\r\n        column_names_gp = gpar(fontsize = pmin(ncol(dataod2h) / 3 + 9, 15)),\r\n        row_title_gp = gpar(fontsize = pmin(ncol(dataod2h) / 3 + 12, 25), just = \"left\"),\r\n        column_title_gp = gpar(fontsize = pmin(ncol(dataod2h) / 3 + 12, 25)),\r\n        row_names_max_width = unit(max_length, \"cm\"),\r\n        column_names_max_height = unit(max_length, \"cm\"),\r\n        heatmap_legend_param = list(labels_gp = gpar(fontsize = pmin(ncol(dataod2h) / 3 + 9, 18)), legend_height = unit(pmin(nrow(dataod2h) / 4 + 1, 8), \"cm\"), at = c(0, 300, 1500, 6000, 30000, 99000), legend_width = unit(2, \"cm\"), color_bar = \"continuous\", title_gp = gpar(fontsize = pmin(ncol(dataod2h) / 3 + 9, 18), fontface = 'bold'), break_dist = 1),\r\n        cell_fun = function(j, i, x, y, width, height, fill) {\r\n          if(dataod2h[i, j] > 5000){\r\n            grid.text(sprintf(\"%.0f\", dataod2h[i, j]), x, y, gp = gpar(fontsize = 13, col = \"white\"))\r\n          }\r\n          else if(dataod2h[i, j] > 29){\r\n            grid.text(sprintf(\"%.0f\", dataod2h[i, j]), x, y, gp = gpar(fontsize = 14))\r\n          }\r\n        },\r\n        rect_gp = gpar(col = \"black\", lwd = 0.2))\r\n    } else {\r\n      ori_stops <- str_split(sp_ori(), \",\")\r\n      dst_stops <- str_split(sp_dst(), \",\")\r\n      l_ori <- length(ori_stops[[1]])\r\n      l_dst <- length(dst_stops[[1]])\r\n      if (l_ori != l_dst) {\r\n        stop(\"The lengths of your origin stops and destination stops do not match.\")\r\n      }\r\n      dataod3 <- data.frame(c(1:l_ori), c(1:l_ori), c(1:l_ori))\r\n      dataod3a <- data.frame(c(1:l_ori), c(1:l_ori))\r\n      colnames(dataod3) <- c(\"ori\", \"dst\", \"dmd\")\r\n      colnames(dataod3a) <- c(\"ori_name\", \"dst_name\")\r\n      for (t in 1:l_ori) {\r\n        ori_stop <- as.numeric(ori_stops[[1]][[t]])\r\n        dst_stop <- as.numeric(dst_stops[[1]][[t]])\r\n        dataod3[t, 1] <- ori_stop\r\n        dataod3[t, 2] <- dst_stop\r\n        valid_stops <- nrow(filter(data1(),\r\n          ORIGIN_PT_CODE %in% dataod3[t, 1] | is.na(ORIGIN_PT_CODE),\r\n          DESTINATION_PT_CODE %in% dataod3[t, 2] | is.na(DESTINATION_PT_CODE),\r\n          !!filter_day_type, !!filter_time_period))\r\n        if (valid_stops == 0) {\r\n          stop(\"Invalid bus stop code(s) detected! Check your codes to see if it's a proper O-D pair, or there's absolutely no one going from A to B.\")\r\n        }\r\n        dataod3[t, 3] <- data1() %>%\r\n          filter(., ORIGIN_PT_CODE == dataod3[t, 1],\r\n            DESTINATION_PT_CODE == dataod3[t, 2],\r\n            !!filter_day_type,\r\n            !!filter_time_period) %>%\r\n          summarise(Total = sum(TOTAL_TRIPS)) %>%\r\n          pull(Total) %>%\r\n          as.numeric()\r\n        if (\"row_names\" %in% input$stop_names) {\r\n          dataod3a[t, 1] <- data3[[as.character(ori_stop)]][[3]]\r\n          dataod3a[t, 2] <- data3[[as.character(dst_stop)]][[3]]\r\n         }\r\n      }\r\n      dataod3 <- as.matrix(dataod3)\r\n      dataod3a <- as.matrix(dataod3a)\r\n      cols = colorRamp2(c(0, 1, 30, 300, 1500, 6000, 30000, 99000), c(\"gray60\",\"white\",\"white\", \"yellow\", \"orange\", \"red\", \"darkred\",\"black\"))\r\n      img_dims <- list(width = 520, height = 23 * nrow(dataod3) + 100)\r\n      img <- Heatmap(dataod3,\r\n        name = paste(day_type, \"Demand,\", time_period),\r\n        show_column_dend = FALSE,\r\n        show_row_dend = FALSE,\r\n        row_dend_reorder = FALSE,\r\n        column_dend_reorder = FALSE,\r\n        column_title = \"O-D Matrix for specific stops\",\r\n        column_title_side = \"top\",\r\n        column_names_side = \"top\",\r\n        column_names_rot = 0,\r\n        column_names_centered = TRUE,\r\n        column_labels = c(\"Origin\", \"Destination\", \"Demand\"),\r\n        col = cols,\r\n        na_col = \"gray60\",\r\n        column_gap = unit(2, \"mm\"),\r\n        cluster_rows = FALSE,\r\n        cluster_columns = FALSE,\r\n        column_names_gp = gpar(fontsize = 15),\r\n        column_title_gp = gpar(fontsize = 25),\r\n        heatmap_legend_param = list(labels_gp = gpar(fontsize = 12), legend_width = unit(10, \"cm\"), legend_direction = \"horizontal\", at = c(0, 300, 1500, 6000, 30000, 99000), legend_width = unit(2, \"cm\"), color_bar = \"continuous\", break_dist = 1, title_position = \"topcenter\", heatmap_legend_side = \"top\", title_gp = gpar(fontsize = 12, fontface = \"bold\")),\r\n        cell_fun = function(j, i, x, y, width, height, fill) {\r\n          if(j %in% c(1, 2)) {\r\n            # Draw a white background covering the cell.\r\n            grid.rect(\r\n              x = x, y = y, width = width, height = height,\r\n              gp = gpar(fill = \"white\", col = \"black\", lwd = 0.2)\r\n            )\r\n            if (input$stop_names2) {\r\n              grid.text(sprintf(\"%s\\n%s\", dataod3[i, j], dataod3a[i, j]), x, y, gp = gpar(fontsize = 11, col = \"black\"))\r\n            } else {\r\n              grid.text(sprintf(\"%s\", dataod3[i, j]), x, y, gp = gpar(fontsize = 15, col = \"black\"))\r\n            }\r\n          }\r\n          if (j ==3) {\r\n            if(dataod3[i, j] > 7000){\r\n              grid.text(sprintf(\"%.0f\", dataod3[i, j]), x, y, gp = gpar(fontsize = 15, col = \"white\"))\r\n            }\r\n            else if(dataod3[i, j] >= 0){\r\n              grid.text(sprintf(\"%.0f\", dataod3[i, j]), x, y, gp = gpar(fontsize = 15))\r\n            }\r\n          }\r\n        },\r\n        rect_gp = gpar(col = \"black\", lwd = 0.2))\r\n      }\r\n      list(img = img, img_dims = img_dims)\r\n  })\r\n  output$result_out <- renderPlot({\r\n    req(result())\r\n    if (identical(spec_stops(), F)) {\r\n      draw(result()$img)\r\n    } else {\r\n      draw(result()$img, heatmap_legend_side = \"top\")\r\n    }\r\n  }, width = function() {\r\n    req(result())\r\n    result()$img_dims$width\r\n  },\r\n  height = function() {\r\n    req(result())\r\n    result()$img_dims$height\r\n  })\r\n  output$upload_conf <- renderText({HTML(conf_msg())})\r\n  output$upload_conf2 <- renderText({HTML(conf_msg2())})\r\n}\r\n\r\nshinyApp(ui, server)\r\nshinyApp(ui = ui, server = server)","type":"text"}]
